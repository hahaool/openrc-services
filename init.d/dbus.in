#!@RUNSCRIPT@
# Copyright 1999-2019 Gentoo Authors
# Distributed under the terms of the GNU General Public License, v2 or later

supervisor=supervise-daemon
description="An IPC message bus daemon"
command="/usr/bin/dbus-daemon"
command_args="--system"
command_args_foreground="--nofork --nopidfile"
extra_started_commands="reload"

dbus_socket="/run/dbus/system_bus_socket"

depend() {
    need localmount
    after bootmisc
}

start_pre() {
    [ -e /etc/machine-id ] || touch /etc/machine-id

    if [ -x /usr/bin/file ]; then
        [ "$(file /etc/machine-id | awk '{print $2}')" != 'empty' ] || /usr/bin/dbus-uuidgen >/etc/machine-id
    elif [ -x /usr/bin/sha256sum ]; then
        [ "$(sha256sum /etc/machine-id)" != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855' ] || /usr/bin/dbus-uuidgen >/etc/machine-id
    else
        [ -s /etc/machine-id ] || /usr/bin/dbus-uuidgen >/etc/machine-id
    fi

    /usr/bin/dbus-uuidgen --ensure=/etc/machine-id

    # We need to test if /run/dbus exists, since script will fail if it does not
    checkpath -q -d "/run/dbus"
}

stop_post() {
    [ ! -S "${dbus_socket}" ] || rm -f "${dbus_socket}"
}

reload() {
    ebegin "Reloading D-BUS messagebus config"
    dbus-send --print-reply --system --type=method_call \
            --dest=org.freedesktop.DBus \
            / org.freedesktop.DBus.ReloadConfig > /dev/null
    eend $?
}
